{"hash":"d7854f84d1ae0307c2d5336bcf545aa865f01b3e","data":{"post":{"title":"Konfiguracja ClusterSettings w MongoDB Java Driver","path":"/konfiguracja-cluster-settings-w-mongo-db-java-driver/","slug":"mongodb-java-driver-cluster-settings-properties","datetime":"2021-10-07 20:22:24","content":"<p>Powszechnie wykorzystywane klienty do łączenia się z bazą danych dostarczają wiele funkcjonalności i możliwości konfiguracji, które można przeoczyć - a są bardzo przydatne i mogą zoptymalizować działanie usługi. Warto poznać parę przydatnych ustawień, które potencjalnie można przetestować w swoich aplikacjach.</p>\n<h3 id=\"czym-są-drivery-do-baz-danych\">Czym są drivery do baz danych?</h3>\n<p>Drivery działają z reguły w taki sposób, że zarządzają połączeniami otwieranymi do bazy danych, dostarczając przydatne funkcje i logikę - na przykład ograniczeniem puli połączeń czy eliminacji gorzej działających hostów. Owrapowują całą logikę w przyjazny interfejs api, odciążając programistę od rozumienia internali Takich rzeczy raczej nie opłaca się implementować samemu od zera, ale nie oznacza to że jest to niewykonalne. Są różne drivery i można nawet do nich kontrybuować, bo w większości przypadków są open-source.</p>\n<h3 id=\"clustersettings\">ClusterSettings</h3>\n<p>Klaster to grupa hostów mongo, które udostępniają razem pewien zbiór danych, składa się z shardów (opcjonalnie), config serverów i replica setów. Ustawienia dotyczące klastra można skonfigurować za pomocą klasy <code>ClusterSettings</code>, która zawiera takie modyfikowalne elementy jak lista hostów, do których chcemy się łączyć, nazwa replicasetu, różne polityki wybierania hostów, którego wykorzystamy do wysłania zapytania do bazy.</p>\n<h3 id=\"localthreshold\">localThreshold</h3>\n<p>Umożliwia sterownikowi wybrać hosty, które mają najszybszy czas odpowiedzi i są na maszynach fizycznych w najbliższej możliwej lokalizacji - na przykład w ramach jednego datacenter. Parametr <code>localTreshold</code> to próg czasu, który zaczyna być odliczany od momentu uzyskania najszybszej odpowiedzi z serwera mongo. Wszystkie hosty, które odpowiedzą w zadanym okresie (ping najszybszego serwera + czas local threshold) zostaną zakwalifikowane do wykonywania żądań do bazy. Najlepiej obrazuje to rysunek:</p>\n<p><img src=\"/images/posts/cluster-settings-mongo/local-threshold.png\" alt=\"Wizualizacja Local Threshold\" title=\"Wizualizacja Local Threshold\"></p>\n<p>Przykładowo: istnieją 3 serwery mongod, które odpowiadają w czasie <code>5ms</code>, <code>9ms</code> i <code>27ms</code>. Ustawiono na sterowniku <code>localThreshold=20ms</code>. Jako że najszybszy czas odpowiedzi to 5ms, a jeszcze do niego należy doliczyć zdefiniowany threshold czyli <code>20ms</code>, to łącznie maksymalny czas odpowiedzi wyniesie <code>25ms</code>. Serwer odpowiadający w czasie 9ms zakwalifikuje się do serwowania danych, natomiast serwer któremu odpowiedź zajęła <code>27ms</code> zostaje odrzucony - ponieważ akceptowano czas maksymalny <code>25ms</code>. </p>\n<p>Jeśli zostanie utracona łączność z serwerem, który wcześniej odpowiadał w <code>5ms</code>, a zostaną nam dwa serwery z <code>9ms</code> i <code>27ms</code>, to wybierzemy oba, ponieważ local threshold się przesunął (<code>9ms + 20ms = 29ms</code>).</p>\n<p>Na dopasowanie tego parametru nie ma uniwersalnego wzoru i trzeba go skonfigurować zgodnie z realnymi czasami z własnych dc, przydatne mogą być w tym celu metryki czasów odpowiedzi. Raczej nie ma większego powodu, by w normalnym trybie działania aplikacji odpytywać nie-lokalne datacenter, a sam <code>localThreshold</code> jest na tyle elastyczny, że może się przesuwać podczas awarii jednej serwerowni i nie odetnie usługi od bazy danych tylko przekieruje do innego datacenter. </p>\n<p>Domyślnie wartość ta przyjmuje <code>15ms</code> w sterowniku javowym, więc raczej nie ma co się niepokoić że aktualnie ruch krąży między dc - chyba że datacenters mają bardzo szybkie czasy odpowiedzi między sobą.</p>\n<p>Przykładowa konfiguracja:</p>\n<pre class=\"shiki\" style=\"background-color: #000000\"><code><span style=\"color: #569CD6\">MongoClient</span><span style=\"color: #FFFFFF\"> mongoClient </span><span style=\"color: #D4D4D4\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #569CD6\">MongoClients</span><span style=\"color: #D4D4D4\">.</span><span style=\"color: #FFFFFF\">create(</span>\n<span style=\"color: #FFFFFF\">                </span><span style=\"color: #569CD6\">MongoClientSettings</span><span style=\"color: #D4D4D4\">.</span><span style=\"color: #FFFFFF\">builder()</span>\n<span style=\"color: #FFFFFF\">                        .applyToClusterSettings(builder </span><span style=\"color: #D4D4D4\">-&gt;</span>\n<span style=\"color: #FFFFFF\">                                builder</span>\n<span style=\"color: #FFFFFF\">                                        .hosts(</span><span style=\"color: #569CD6\">Collections</span><span style=\"color: #D4D4D4\">.</span><span style=\"color: #FFFFFF\">singletonList(</span><span style=\"color: #569CD6\">new</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #569CD6\">ServerAddress</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #CE9178\">\"mongos.somedomain.local\"</span><span style=\"color: #FFFFFF\">, </span><span style=\"color: #B5CEA8\">27017</span><span style=\"color: #FFFFFF\">)))</span>\n<span style=\"color: #FFFFFF\">                                        .localThreshold(</span><span style=\"color: #B5CEA8\">50</span><span style=\"color: #FFFFFF\">, </span><span style=\"color: #569CD6\">TimeUnit</span><span style=\"color: #D4D4D4\">.</span><span style=\"color: #FFFFFF\">MILLISECONDS)</span>\n<span style=\"color: #FFFFFF\">                        )</span>\n<span style=\"color: #FFFFFF\">                        .build())</span></code></pre>\n<h3 id=\"serverselectiontimeout\">serverSelectionTimeout</h3>\n<p>Podobnie jak localThreshold, umożliwia sterownikowi odseparowanie hostów z najgorszymi czasami odpowiedzi. Tym razem to jest maksymalny czas, po którym przestaniemy uwzględniać tego hosta. Może być przydatny w momencie, gdy wszystkie hosty będą przeciążone i nie warto już dociążać ich bardziej.</p>\n<p>Przykładowo, wszystkie hosty są obciążone i mają ping <code>470ms</code>, <code>490ms</code>, <code>550ms</code>. Przy <code>serverSelectionTimeout=500ms</code> odrzucimy hosta który odpowiedział sumarycznie w czasie <code>550ms</code>.</p>\n<p>Domyślnie przyjmuje wartość <code>30s</code>.</p>\n<p>Przykładowa konfiguracja:</p>\n<pre class=\"shiki\" style=\"background-color: #000000\"><code><span style=\"color: #569CD6\">MongoClient</span><span style=\"color: #FFFFFF\"> mongoClient </span><span style=\"color: #D4D4D4\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #569CD6\">MongoClients</span><span style=\"color: #D4D4D4\">.</span><span style=\"color: #FFFFFF\">create(</span>\n<span style=\"color: #FFFFFF\">                </span><span style=\"color: #569CD6\">MongoClientSettings</span><span style=\"color: #D4D4D4\">.</span><span style=\"color: #FFFFFF\">builder()</span>\n<span style=\"color: #FFFFFF\">                        .applyToClusterSettings(builder </span><span style=\"color: #D4D4D4\">-&gt;</span>\n<span style=\"color: #FFFFFF\">                                builder</span>\n<span style=\"color: #FFFFFF\">                                        .hosts(</span><span style=\"color: #569CD6\">Collections</span><span style=\"color: #D4D4D4\">.</span><span style=\"color: #FFFFFF\">singletonList(</span><span style=\"color: #569CD6\">new</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #569CD6\">ServerAddress</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #CE9178\">\"mongos.somedomain.local\"</span><span style=\"color: #FFFFFF\">, </span><span style=\"color: #B5CEA8\">27017</span><span style=\"color: #FFFFFF\">)))</span>\n<span style=\"color: #FFFFFF\">                              .serverSelectionTimeout(</span><span style=\"color: #B5CEA8\">500</span><span style=\"color: #FFFFFF\">, </span><span style=\"color: #569CD6\">TimeUnit</span><span style=\"color: #D4D4D4\">.</span><span style=\"color: #FFFFFF\">MILLISECONDS)</span>\n<span style=\"color: #FFFFFF\">                        )</span>\n<span style=\"color: #FFFFFF\">                        .build());</span></code></pre>\n<h3 id=\"requiredreplicasetname\">requiredReplicaSetName</h3>\n<p>Nazwa replicasetu, z którym aplikacja ma się połączyć. Przydatne, jeśli istnieje wiele replicasetów na jednym klastrze. </p>\n<h3 id=\"clusterlistener\">clusterListener</h3>\n<p>Listener, dzięki któremu można nasłuchiwać na zdarzenia związane z klastrem - połączenie, zmianę, zamknięcie połączenia. Przydatne przy zbieraniu metryk, debugowaniu, integracjach z bibliotekami. Aby to wykorzystać, należy zaimplementować metody w interfejsie ClusterListener (jawnie lub zaimplementować jako nową klasę).</p>\n<p>Przykładowa konfiguracja:</p>\n<pre class=\"shiki\" style=\"background-color: #000000\"><code><span style=\"color: #569CD6\">MongoClient</span><span style=\"color: #FFFFFF\"> mongoClient </span><span style=\"color: #D4D4D4\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #569CD6\">MongoClients</span><span style=\"color: #D4D4D4\">.</span><span style=\"color: #FFFFFF\">create(</span>\n<span style=\"color: #FFFFFF\">                </span><span style=\"color: #569CD6\">MongoClientSettings</span><span style=\"color: #D4D4D4\">.</span><span style=\"color: #FFFFFF\">builder()</span>\n<span style=\"color: #FFFFFF\">                        .applyToClusterSettings(builder </span><span style=\"color: #D4D4D4\">-&gt;</span>\n<span style=\"color: #FFFFFF\">                                builder</span>\n<span style=\"color: #FFFFFF\">                                        .hosts(</span><span style=\"color: #569CD6\">Collections</span><span style=\"color: #D4D4D4\">.</span><span style=\"color: #FFFFFF\">singletonList(</span><span style=\"color: #569CD6\">new</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #569CD6\">ServerAddress</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #CE9178\">\"mongos.somedomain.local\"</span><span style=\"color: #FFFFFF\">, </span><span style=\"color: #B5CEA8\">27017</span><span style=\"color: #FFFFFF\">)))</span>\n<span style=\"color: #FFFFFF\">                                        .addClusterListener(</span><span style=\"color: #569CD6\">new</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #569CD6\">ClusterListener</span><span style=\"color: #FFFFFF\">() {</span>\n<span style=\"color: #FFFFFF\">                                            </span><span style=\"color: #569CD6\">@Override</span>\n<span style=\"color: #FFFFFF\">                                            </span><span style=\"color: #569CD6\">public</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #569CD6\">void</span><span style=\"color: #FFFFFF\"> clusterOpening(</span><span style=\"color: #569CD6\">ClusterOpeningEvent</span><span style=\"color: #FFFFFF\"> event) {</span>\n<span style=\"color: #FFFFFF\">                                                logger</span><span style=\"color: #D4D4D4\">.</span><span style=\"color: #FFFFFF\">info(</span><span style=\"color: #CE9178\">\"Successfully connected to cluster with id: {}\"</span><span style=\"color: #FFFFFF\">, event</span><span style=\"color: #D4D4D4\">.</span><span style=\"color: #FFFFFF\">getClusterId());</span>\n<span style=\"color: #FFFFFF\">                                                registerMetrics(event);</span>\n<span style=\"color: #FFFFFF\">                                                sendSomeInfoSomewhere();</span>\n<span style=\"color: #FFFFFF\">                                                doSomething();</span>\n<span style=\"color: #FFFFFF\">                                            }</span>\n\n<span style=\"color: #FFFFFF\">                                            </span><span style=\"color: #569CD6\">@Override</span>\n<span style=\"color: #FFFFFF\">                                            </span><span style=\"color: #569CD6\">public</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #569CD6\">void</span><span style=\"color: #FFFFFF\"> clusterClosed(</span><span style=\"color: #569CD6\">ClusterClosedEvent</span><span style=\"color: #FFFFFF\"> event) {</span>\n<span style=\"color: #FFFFFF\">                                                logger</span><span style=\"color: #D4D4D4\">.</span><span style=\"color: #FFFFFF\">info(</span><span style=\"color: #CE9178\">\"Connection to cluster closed with id: {}\"</span><span style=\"color: #FFFFFF\">, event</span><span style=\"color: #D4D4D4\">.</span><span style=\"color: #FFFFFF\">getClusterId());</span>\n<span style=\"color: #FFFFFF\">                                                sendSomeInfoSomewhere();</span>\n<span style=\"color: #FFFFFF\">                                            }</span>\n\n<span style=\"color: #FFFFFF\">                                            </span><span style=\"color: #569CD6\">@Override</span>\n<span style=\"color: #FFFFFF\">                                            </span><span style=\"color: #569CD6\">public</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #569CD6\">void</span><span style=\"color: #FFFFFF\"> clusterDescriptionChanged(</span><span style=\"color: #569CD6\">ClusterDescriptionChangedEvent</span><span style=\"color: #FFFFFF\"> event) {</span>\n<span style=\"color: #FFFFFF\">                                                logger</span><span style=\"color: #D4D4D4\">.</span><span style=\"color: #FFFFFF\">info(</span><span style=\"color: #CE9178\">\"Cluster description changed with id: {}\"</span><span style=\"color: #FFFFFF\">, event</span><span style=\"color: #D4D4D4\">.</span><span style=\"color: #FFFFFF\">getClusterId());</span>\n<span style=\"color: #FFFFFF\">                                                doSomething();</span>\n<span style=\"color: #FFFFFF\">                                            }</span>\n<span style=\"color: #FFFFFF\">                                        })</span>\n<span style=\"color: #FFFFFF\">                        )</span></code></pre>\n<h3 id=\"dokumentacja-mongodb\">Dokumentacja MongoDB</h3>\n<p>Zachęcam do skorzystania z <a href=\"http://mongodb.github.io/mongo-java-driver/4.3/apidocs/mongodb-driver-core/com/mongodb/connection/ClusterSettings.Builder.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">dokumentacji mongo-java-drivera dla ClusterSettings</a>. Można tu znaleźć wiele przydatnych informacji na temat tych i innych parametrów. O parametrach można przeczytać również w <a href=\"https://github.com/mongodb/specifications/blob/master/source/server-selection/server-selection.rst#localthresholdms\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">oficjalnych wytycznych</a>_.</p>\n<p>To kilka przydatnych wartości, które warto znać i świadomie wykorzystywać. </p>\n","description":"Powszechnie wykorzystywane klienty do łączenia się z bazą danych dostarczają wiele przydatnych funkcjonalności i możliwości konfiguracji. Warto poznać parę ustawień, które potencjalnie mogą usprawnić pracę Twoich aplikacji.","timeToRead":4,"cover":"/images/posts/cluster-settings-mongo/adjusting.jpg","author":{"id":"Julia Glaszka","title":"Julia Glaszka"},"tags":[{"id":"mongodb","title":"mongodb","path":"/tag/mongodb/"},{"id":"java","title":"java","path":"/tag/java/"},{"id":"database","title":"database","path":"/tag/database/"}]},"recommendedposts":{"edges":[{"node":{"id":"5c6912511fbf00580160f309c8bff279","title":"Obiektywizm a rozwój w IT","path":"/obiektywizm-a-rozwoj-w-it/","cover":"/images/posts/obiektywizm/atlas.jpg"}},{"node":{"id":"507900b37c02db543d8fa26f4705fb1e","title":"Wykorzystaj cały potencjał klastra MongoDB z pomocą preferencji odczytu","path":"/wykorzystaj-caly-potencjal-klastra-mongo-db-z-pomoca-preferencji-odczytu/","cover":"/images/posts/mongodb-read-preferences/route.jpg"}},{"node":{"id":"c854d4a554f3e6aa74a421fac8beb243","title":"Konfiguracja ClusterSettings w MongoDB Java Driver","path":"/konfiguracja-cluster-settings-w-mongo-db-java-driver/","cover":"/images/posts/cluster-settings-mongo/adjusting.jpg"}}]}},"context":{}}