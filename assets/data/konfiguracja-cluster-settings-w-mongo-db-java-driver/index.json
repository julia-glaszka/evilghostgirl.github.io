{"hash":"204317353d0f739112acee082258779693cb4278","data":{"post":{"title":"Konfiguracja ClusterSettings w MongoDB Java Driver","path":"/konfiguracja-cluster-settings-w-mongo-db-java-driver/","slug":"mongodb-java-driver-cluster-settings-properties","datetime":"2021-10-07 20:22:24","content":"<p>Powszechnie wykorzystywane klienty do łączenia się z bazą danych dostarczają wiele funkcjonalności i możliwości konfiguracji, które można przeoczyć - a są bardzo przydatne i mogą zoptymalizować działanie usługi. Warto poznać parę przydatnych settingsów, które potencjalnie można przetestować.</p>\n<h3 id=\"czym-są-drivery\">Czym są drivery?</h3>\n<p>Drivery działają z reguły w taki sposób, że zarządzają połączeniami otwieranymi do bazy danych, dostarczając przydatne funkcje i logikę - na przykład ograniczeniem puli połączeń czy eliminacji gorzej działających hostów. Owrapowują całą logikę w przyjazny interfejs api, odciążając programistę od rozumienia internali Takich rzeczy raczej nie opłaca się implementować samemu od zera, ale nie oznacza to że jest to niewykonalne. Są różne drivery i można nawet do nich kontrybuować, bo w większości przypadków są open-source.</p>\n<h3 id=\"clustersettings\">ClusterSettings</h3>\n<p>Klaster to grupa hostów mongo, które udostępniają razem pewien zbiór danych, składa się z shardów (opcjonalnie), config serverów i replica setów. Ustawienia dotyczące klastra można skonfigurować za pomocą klasy <code>ClusterSettings</code>, która zawiera takie modyfikowalne elementy jak lista hostów, do których chcemy się łączyć, nazwa replicasetu, różne polityki wybierania hostów, którego wykorzystamy do wysłania zapytania do bazy.</p>\n<h3 id=\"localthreshold\">localThreshold</h3>\n<p>Umożliwia sterownikowi wybrać hosty, które mają najszybszy czas odpowiedzi i są na maszynach fizycznych w najbliższej możliwej lokalizacji - na przykład w ramach jednego datacenter. Parametr <code>localTreshold</code> to próg czasu, który zaczyna być odliczany od momentu uzyskania najszybszej odpowiedzi z serwera mongo. Wszystkie hosty, które odpowiedzą w zadanym okresie (ping najszybszego serwera + czas local threshold) zostaną zakwalifikowane do wykonywania żądań do bazy. Najlepiej obrazuje to rysunek:</p>\n<p><img src=\"/images/posts/cluster-settings-mongo/local-threshold.png\" alt=\"Wizualizacja Local Threshold\" title=\"Wizualizacja Local Threshold\"></p>\n<p>Przykładowo: istnieją 3 serwery mongod, które odpowiadają w czasie <code>5ms</code>, <code>9ms</code> i <code>27ms</code>. Ustawiono na sterowniku <code>localThreshold=20ms</code>. Jako że najszybszy czas odpowiedzi to 5ms, a jeszcze do niego należy doliczyć zdefiniowany threshold czyli <code>20ms</code>, to łącznie maksymalny czas odpowiedzi wyniesie <code>25ms</code>. Serwer odpowiadający w czasie 9ms zakwalifikuje się do serwowania danych, natomiast serwer któremu odpowiedź zajęła <code>27ms</code> zostaje odrzucony - ponieważ akceptowano czas maksymalny <code>25ms</code>. </p>\n<p>Jeśli zostanie utracona łączność z serwerem, który wcześniej odpowiadał w <code>5ms</code>, a zostaną nam dwa serwery z <code>9ms</code> i <code>27ms</code>, to wybierzemy oba, ponieważ local threshold się przesunął (<code>9ms + 20ms = 29ms</code>).</p>\n<p>Na dopasowanie tego parametru nie ma uniwersalnego wzoru i trzeba go skonfigurować zgodnie z realnymi czasami z własnych dc, przydatne mogą być w tym celu metryki czasów odpowiedzi. Raczej nie ma większego powodu, by w normalnym trybie działania aplikacji odpytywać nie-lokalne datacenter, a sam <code>localThreshold</code> jest na tyle elastyczny, że może się przesuwać podczas awarii jednej serwerowni i nie odetnie usługi od bazy danych tylko przekieruje do innego datacenter. </p>\n<p>Domyślnie wartość ta przyjmuje <code>15ms</code> w sterowniku javowym, więc raczej nie ma co się niepokoić że aktualnie ruch krąży między dc - chyba że datacenters mają bardzo szybkie czasy odpowiedzi między sobą.</p>\n<p>Przykładowa konfiguracja:</p>\n<pre class=\"shiki\" style=\"background-color: #2e3440\"><code><span style=\"color: #8FBCBB\">MongoClient</span><span style=\"color: #D8DEE9FF\"> mongoClient </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">MongoClients</span><span style=\"color: #81A1C1\">.</span><span style=\"color: #88C0D0\">create</span><span style=\"color: #ECEFF4\">(</span>\n<span style=\"color: #D8DEE9FF\">                </span><span style=\"color: #8FBCBB\">MongoClientSettings</span><span style=\"color: #81A1C1\">.</span><span style=\"color: #88C0D0\">builder</span><span style=\"color: #ECEFF4\">()</span>\n<span style=\"color: #D8DEE9FF\">                        .</span><span style=\"color: #88C0D0\">applyToClusterSettings</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #D8DEE9FF\">builder </span><span style=\"color: #81A1C1\">-&gt;</span>\n<span style=\"color: #D8DEE9FF\">                                builder</span>\n<span style=\"color: #D8DEE9FF\">                                        .</span><span style=\"color: #88C0D0\">hosts</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #8FBCBB\">Collections</span><span style=\"color: #81A1C1\">.</span><span style=\"color: #88C0D0\">singletonList</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #81A1C1\">new</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">ServerAddress</span><span style=\"color: #D8DEE9FF\">(</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #A3BE8C\">mongos.somedomain.local</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #D8DEE9FF\">, </span><span style=\"color: #B48EAD\">27017</span><span style=\"color: #D8DEE9FF\">)</span><span style=\"color: #ECEFF4\">))</span>\n<span style=\"color: #D8DEE9FF\">                                        .</span><span style=\"color: #88C0D0\">localThreshold</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #B48EAD\">50</span><span style=\"color: #ECEFF4\">,</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">TimeUnit</span><span style=\"color: #81A1C1\">.</span><span style=\"color: #D8DEE9\">MILLISECONDS</span><span style=\"color: #ECEFF4\">)</span>\n<span style=\"color: #D8DEE9FF\">                        </span><span style=\"color: #ECEFF4\">)</span>\n<span style=\"color: #D8DEE9FF\">                        .</span><span style=\"color: #88C0D0\">build</span><span style=\"color: #ECEFF4\">())</span></code></pre>\n<h3 id=\"serverselectiontimeout\">serverSelectionTimeout</h3>\n<p>Podobnie jak localThreshold, umożliwia sterownikowi odseparowanie hostów z najgorszymi czasami odpowiedzi. Tym razem to jest maksymalny czas, po którym przestaniemy uwzględniać tego hosta. Może być przydatny w momencie, gdy wszystkie hosty będą przeciążone i nie warto już dociążać ich bardziej.</p>\n<p>Przykładowo, wszystkie hosty są obciążone i mają ping <code>470ms</code>, <code>490ms</code>, <code>550ms</code>. Przy <code>serverSelectionTimeout=500ms</code> odrzucimy hosta który odpowiedział sumarycznie w czasie <code>550ms</code>.</p>\n<p>Domyślnie przyjmuje wartość <code>30s</code>.</p>\n<p>Przykładowa konfiguracja:</p>\n<pre class=\"shiki\" style=\"background-color: #2e3440\"><code><span style=\"color: #8FBCBB\">MongoClient</span><span style=\"color: #D8DEE9FF\"> mongoClient </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">MongoClients</span><span style=\"color: #81A1C1\">.</span><span style=\"color: #88C0D0\">create</span><span style=\"color: #ECEFF4\">(</span>\n<span style=\"color: #D8DEE9FF\">                </span><span style=\"color: #8FBCBB\">MongoClientSettings</span><span style=\"color: #81A1C1\">.</span><span style=\"color: #88C0D0\">builder</span><span style=\"color: #ECEFF4\">()</span>\n<span style=\"color: #D8DEE9FF\">                        .</span><span style=\"color: #88C0D0\">applyToClusterSettings</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #D8DEE9FF\">builder </span><span style=\"color: #81A1C1\">-&gt;</span>\n<span style=\"color: #D8DEE9FF\">                                builder</span>\n<span style=\"color: #D8DEE9FF\">                                        .</span><span style=\"color: #88C0D0\">hosts</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #8FBCBB\">Collections</span><span style=\"color: #81A1C1\">.</span><span style=\"color: #88C0D0\">singletonList</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #81A1C1\">new</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">ServerAddress</span><span style=\"color: #D8DEE9FF\">(</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #A3BE8C\">mongos.somedomain.local</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #D8DEE9FF\">, </span><span style=\"color: #B48EAD\">27017</span><span style=\"color: #D8DEE9FF\">)</span><span style=\"color: #ECEFF4\">))</span>\n<span style=\"color: #D8DEE9FF\">                              .</span><span style=\"color: #88C0D0\">serverSelectionTimeout</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #B48EAD\">500</span><span style=\"color: #ECEFF4\">,</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">TimeUnit</span><span style=\"color: #81A1C1\">.</span><span style=\"color: #D8DEE9\">MILLISECONDS</span><span style=\"color: #ECEFF4\">)</span>\n<span style=\"color: #D8DEE9FF\">                        </span><span style=\"color: #ECEFF4\">)</span>\n<span style=\"color: #D8DEE9FF\">                        .</span><span style=\"color: #88C0D0\">build</span><span style=\"color: #ECEFF4\">())</span><span style=\"color: #81A1C1\">;</span></code></pre>\n<h3 id=\"requiredreplicasetname\">requiredReplicaSetName</h3>\n<p>Nazwa replicasetu, z którym aplikacja ma się połączyć. Przydatne, jeśli istnieje wiele replicasetów na jednym klastrze. </p>\n<h3 id=\"clusterlistener\">clusterListener</h3>\n<p>Listener, dzięki któremu można nasłuchiwać na zdarzenia związane z klastrem - połączenie, zmianę, zamknięcie połączenia. Przydatne przy zbieraniu metryk, debugowaniu, integracjach z bibliotekami. Aby to wykorzystać, należy zaimplementować metody w interfejsie ClusterListener (jawnie lub zaimplementować jako nową klasę).</p>\n<p>Przykładowa konfiguracja:</p>\n<pre class=\"shiki\" style=\"background-color: #2e3440\"><code><span style=\"color: #8FBCBB\">MongoClient</span><span style=\"color: #D8DEE9FF\"> mongoClient </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">MongoClients</span><span style=\"color: #81A1C1\">.</span><span style=\"color: #88C0D0\">create</span><span style=\"color: #ECEFF4\">(</span>\n<span style=\"color: #D8DEE9FF\">                </span><span style=\"color: #8FBCBB\">MongoClientSettings</span><span style=\"color: #81A1C1\">.</span><span style=\"color: #88C0D0\">builder</span><span style=\"color: #ECEFF4\">()</span>\n<span style=\"color: #D8DEE9FF\">                        .</span><span style=\"color: #88C0D0\">applyToClusterSettings</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #D8DEE9FF\">builder </span><span style=\"color: #81A1C1\">-&gt;</span>\n<span style=\"color: #D8DEE9FF\">                                builder</span>\n<span style=\"color: #D8DEE9FF\">                                        .</span><span style=\"color: #88C0D0\">hosts</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #8FBCBB\">Collections</span><span style=\"color: #81A1C1\">.</span><span style=\"color: #88C0D0\">singletonList</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #81A1C1\">new</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">ServerAddress</span><span style=\"color: #D8DEE9FF\">(</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #A3BE8C\">mongos.somedomain.local</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #D8DEE9FF\">, </span><span style=\"color: #B48EAD\">27017</span><span style=\"color: #D8DEE9FF\">)</span><span style=\"color: #ECEFF4\">))</span>\n<span style=\"color: #D8DEE9FF\">                                        .</span><span style=\"color: #88C0D0\">addClusterListener</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #81A1C1\">new</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">ClusterListener</span><span style=\"color: #D8DEE9FF\">() </span><span style=\"color: #ECEFF4\">{</span>\n<span style=\"color: #D8DEE9FF\">                                            </span><span style=\"color: #D08770\">@Override</span>\n<span style=\"color: #D8DEE9FF\">                                            </span><span style=\"color: #81A1C1\">public</span><span style=\"color: #88C0D0\"> </span><span style=\"color: #81A1C1\">void</span><span style=\"color: #88C0D0\"> clusterOpening(</span><span style=\"color: #8FBCBB\">ClusterOpeningEvent</span><span style=\"color: #88C0D0\"> </span><span style=\"color: #D8DEE9\">event</span><span style=\"color: #88C0D0\">) </span><span style=\"color: #ECEFF4\">{</span>\n<span style=\"color: #88C0D0\">                                                logger</span><span style=\"color: #81A1C1\">.</span><span style=\"color: #88C0D0\">info</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #A3BE8C\">Successfully connected to cluster with id: {}</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #ECEFF4\">,</span><span style=\"color: #88C0D0\"> event</span><span style=\"color: #81A1C1\">.</span><span style=\"color: #88C0D0\">getClusterId</span><span style=\"color: #ECEFF4\">())</span><span style=\"color: #81A1C1\">;</span>\n<span style=\"color: #88C0D0\">                                                registerMetrics</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #88C0D0\">event</span><span style=\"color: #ECEFF4\">)</span><span style=\"color: #81A1C1\">;</span>\n<span style=\"color: #88C0D0\">                                                sendSomeInfoSomewhere</span><span style=\"color: #ECEFF4\">()</span><span style=\"color: #81A1C1\">;</span>\n<span style=\"color: #88C0D0\">                                                doSomething</span><span style=\"color: #ECEFF4\">()</span><span style=\"color: #81A1C1\">;</span>\n<span style=\"color: #88C0D0\">                                            </span><span style=\"color: #ECEFF4\">}</span>\n\n<span style=\"color: #D8DEE9FF\">                                            </span><span style=\"color: #D08770\">@Override</span>\n<span style=\"color: #D8DEE9FF\">                                            </span><span style=\"color: #81A1C1\">public</span><span style=\"color: #88C0D0\"> </span><span style=\"color: #81A1C1\">void</span><span style=\"color: #88C0D0\"> clusterClosed(</span><span style=\"color: #8FBCBB\">ClusterClosedEvent</span><span style=\"color: #88C0D0\"> </span><span style=\"color: #D8DEE9\">event</span><span style=\"color: #88C0D0\">) </span><span style=\"color: #ECEFF4\">{</span>\n<span style=\"color: #88C0D0\">                                                logger</span><span style=\"color: #81A1C1\">.</span><span style=\"color: #88C0D0\">info</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #A3BE8C\">Connection to cluster closed with id: {}</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #ECEFF4\">,</span><span style=\"color: #88C0D0\"> event</span><span style=\"color: #81A1C1\">.</span><span style=\"color: #88C0D0\">getClusterId</span><span style=\"color: #ECEFF4\">())</span><span style=\"color: #81A1C1\">;</span>\n<span style=\"color: #88C0D0\">                                                sendSomeInfoSomewhere</span><span style=\"color: #ECEFF4\">()</span><span style=\"color: #81A1C1\">;</span>\n<span style=\"color: #88C0D0\">                                            </span><span style=\"color: #ECEFF4\">}</span>\n\n<span style=\"color: #D8DEE9FF\">                                            </span><span style=\"color: #D08770\">@Override</span>\n<span style=\"color: #D8DEE9FF\">                                            </span><span style=\"color: #81A1C1\">public</span><span style=\"color: #88C0D0\"> </span><span style=\"color: #81A1C1\">void</span><span style=\"color: #88C0D0\"> clusterDescriptionChanged(</span><span style=\"color: #8FBCBB\">ClusterDescriptionChangedEvent</span><span style=\"color: #88C0D0\"> </span><span style=\"color: #D8DEE9\">event</span><span style=\"color: #88C0D0\">) </span><span style=\"color: #ECEFF4\">{</span>\n<span style=\"color: #88C0D0\">                                                logger</span><span style=\"color: #81A1C1\">.</span><span style=\"color: #88C0D0\">info</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #A3BE8C\">Cluster description changed with id: {}</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #ECEFF4\">,</span><span style=\"color: #88C0D0\"> event</span><span style=\"color: #81A1C1\">.</span><span style=\"color: #88C0D0\">getClusterId</span><span style=\"color: #ECEFF4\">())</span><span style=\"color: #81A1C1\">;</span>\n<span style=\"color: #88C0D0\">                                                doSomething</span><span style=\"color: #ECEFF4\">()</span><span style=\"color: #81A1C1\">;</span>\n<span style=\"color: #88C0D0\">                                            </span><span style=\"color: #ECEFF4\">}</span>\n<span style=\"color: #D8DEE9FF\">                                        </span><span style=\"color: #ECEFF4\">})</span>\n<span style=\"color: #D8DEE9FF\">                        </span><span style=\"color: #ECEFF4\">)</span></code></pre>\n<h3 id=\"dokumentacja-mongodb\">Dokumentacja MongoDB</h3>\n<p>Zachęcam do skorzystania z <a href=\"http://mongodb.github.io/mongo-java-driver/4.3/apidocs/mongodb-driver-core/com/mongodb/connection/ClusterSettings.Builder.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">dokumentacji mongo-java-drivera dla ClusterSettings</a>. Można tu znaleźć wiele przydatnych informacji na temat tych i innych parametrów. O parametrach można przeczytać również w <a href=\"https://github.com/mongodb/specifications/blob/master/source/server-selection/server-selection.rst#localthresholdms\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">oficjalnych wytycznych</a>_.</p>\n<p>To kilka przydatnych wartości, które warto znać i świadomie wykorzystywać. </p>\n","description":"Konfiguracja ClusterSettings w MongoDB Java Driver","timeToRead":3,"cover":"/images/posts/cluster-settings-mongo/local-threshold.png","author":{"id":"Julia","title":"Julia","path":"/author/Julia/"},"tags":[{"id":"mongodb","title":"mongodb","path":"/tag/mongodb/"},{"id":"java","title":"java","path":"/tag/java/"},{"id":"data","title":"data","path":"/tag/data/"},{"id":"database","title":"database","path":"/tag/database/"}]}},"context":{}}